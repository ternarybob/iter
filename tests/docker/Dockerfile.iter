# Dockerfile for iter-service server
# Minimal image that runs the iter-service API and MCP endpoints

FROM golang:1.24-bookworm AS builder

WORKDIR /build
COPY go.mod go.sum ./
RUN go mod download

COPY . .
RUN CGO_ENABLED=0 go build -o iter-service ./cmd/iter-service

# Runtime image
FROM debian:bookworm-slim

RUN apt-get update && apt-get install -y \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy binary
COPY --from=builder /build/iter-service /app/iter-service

# Copy config from repo (config.example.toml is the tracked reference)
COPY configs/config.example.toml /app/config.toml

# Create data directory
RUN mkdir -p /app/data

# Override config for container networking (bind to 0.0.0.0, use container paths)
RUN sed -i 's/host = "127.0.0.1"/host = "0.0.0.0"/' /app/config.toml && \
    sed -i 's/port = 8420/port = 19000/' /app/config.toml && \
    sed -i 's/output = \["file"\]/output = ["stdout"]/' /app/config.toml && \
    sed -i 's/level = "info"/level = "debug"/' /app/config.toml

# Expose port
EXPOSE 19000

# Run service
CMD ["/app/iter-service", "--config", "/app/config.toml"]
