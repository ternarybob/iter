# Dockerfile for iter-service server
# Uses pre-built binary from tests/bin/iter-service
# This ensures the exact same binary is tested in Docker as locally
#
# Prerequisites:
#   go build -o tests/bin/iter-service ./cmd/iter-service
# Or:
#   scripts/run-docker-tests.sh  (builds automatically)

FROM debian:bookworm-slim

# Install runtime dependencies only (no Go needed)
RUN apt-get update && apt-get install -y \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Create a test user (simulates real user deployment)
RUN useradd -m -s /bin/bash testuser
USER testuser
WORKDIR /home/testuser

# Create standard directories (as install script would)
RUN mkdir -p /home/testuser/.local/bin \
    /home/testuser/.config/iter-service \
    /home/testuser/.iter-service/logs

# Copy pre-built binary from tests/bin/
COPY --chown=testuser:testuser tests/bin/iter-service /home/testuser/.local/bin/iter-service

# Copy default config
COPY --chown=testuser:testuser configs/config.example.toml /home/testuser/.config/iter-service/config.toml

# Configure for container networking
RUN sed -i 's/host = "127.0.0.1"/host = "0.0.0.0"/' /home/testuser/.config/iter-service/config.toml && \
    sed -i 's/port = 8420/port = 19000/' /home/testuser/.config/iter-service/config.toml && \
    sed -i 's/output = \["file"\]/output = ["stdout"]/' /home/testuser/.config/iter-service/config.toml && \
    sed -i 's/level = "info"/level = "debug"/' /home/testuser/.config/iter-service/config.toml

# Set PATH
ENV PATH="/home/testuser/.local/bin:${PATH}"

# Expose port
EXPOSE 19000

# Run the service
CMD ["iter-service", "serve", "--config", "/home/testuser/.config/iter-service/config.toml"]
