# Docker Compose for iter-service testing
# Two containers: iter-service server and Claude test runner
# No volume mounts to repo - files are copied in/out

services:
  # iter-service server - runs the API and MCP endpoints
  iter:
    build:
      context: ../..
      dockerfile: tests/docker/Dockerfile.iter
    container_name: iter-server
    ports:
      - "19000:19000"
    environment:
      - ITER_TEST_MODE=1
      - ITER_PORT=19000
      - GOOGLE_GEMINI_API_KEY=${GOOGLE_GEMINI_API_KEY:-}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:19000/health"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Claude test runner - executes tests against iter server
  claude:
    build:
      context: ../..
      dockerfile: tests/docker/Dockerfile.claude
    container_name: claude-runner
    depends_on:
      iter:
        condition: service_healthy
    environment:
      - ITER_BASE_URL=http://iter:19000
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - HOME=/home/testuser
      - CHROME_BIN=/usr/bin/chromium
      - CHROMEDP_NO_SANDBOX=true
    # Keep container running for test execution
    command: tail -f /dev/null
    stdin_open: true
    tty: true
